---
phase: 02-rpi5-hardware-demos
plan: 02
type: execute
---

<objective>
Demonstrate PWM motor command tracing via BPF with nanosecond timestamps streamed to userspace on RPi5.

Purpose: Prove the observability thesis — attach a BPF probe to PWM operations and trace motor commands with precise timing, all without modifying the kernel.
Output: pwm_demo running on RPi5, PWM duty cycle changes traced via ringbuf with nanosecond timestamps visible on serial.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-rpi5-hardware-demos/02-01-SUMMARY.md

**Key files:**
@userspace/pwm_demo/src/main.rs
@kernel/src/arch/aarch64/platform/rpi5/pwm.rs
@kernel/src/bpf/helpers.rs
@kernel/src/bpf/mod.rs
@kernel/crates/kernel_abi/src/bpf.rs

**Prior context:**
- Plan 02-01 fixed deadlock in all hook handlers (lock-free pattern)
- PWM trigger_event() now uses lock-free BPF execution
- pwm_demo already exists with two BPF programs: observer (PWM attach) + controller (timer attach)
- PWM helpers: bpf_pwm_write (helper for setting duty cycle), bpf_ktime_get_ns (timestamps)
- BPF_RINGBUF_POLL = 37 for userspace ringbuf consumption
- Lock-free pattern: get_hook_programs() + execute_program()

**Branch:** phase2-rpi5-hardware-demos
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance pwm_demo with ringbuf event tracing for nanosecond timestamps</name>
  <files>userspace/pwm_demo/src/main.rs, userspace/init/src/main.rs</files>
  <action>
  The existing pwm_demo has two BPF programs (observer + controller) but doesn't use ringbuf for structured event output to userspace.

  Enhance pwm_demo to:
  1. Create a ringbuf map (in addition to existing program logic)
  2. Modify the PWM observer BPF program to write events to ringbuf:
     - Event data: timestamp (from bpf_ktime_get_ns), duty cycle value, channel
     - Use bpf_ringbuf_output helper
  3. Add a userspace event loop that:
     - Polls ringbuf via sys_bpf(BPF_RINGBUF_POLL)
     - Formats and prints: "PWM [channel] duty=[X]% at t=[nanoseconds]"
     - Shows timing precision of kernel-level tracing

  Read the existing pwm_demo code first to understand its current structure. Build on it rather than rewriting from scratch. The controller program (timer-attached, varies duty cycle) can stay as-is.

  Update init to exec pwm_demo instead of gpio_demo.

  Avoid: Don't change the PWM driver itself. Don't modify the kernel BPF subsystem. This is userspace-only work building on the infrastructure from 02-01.
  </action>
  <verify>cargo build --target aarch64-unknown-none --features "aarch64_arch,rpi5" succeeds with enhanced pwm_demo</verify>
  <done>pwm_demo enhanced with ringbuf tracing, shows nanosecond-precision PWM events on serial</done>
</task>

<task type="auto">
  <name>Task 2: Build for RPi5 and deploy</name>
  <files>scripts/build-rpi5.sh</files>
  <action>
  1. Build for RPi5: scripts/build-rpi5.sh
  2. Verify kernel8.img created
  3. Ensure pwm_demo is in disk image

  Avoid: Don't test in QEMU — PWM requires real hardware.
  </action>
  <verify>RPi5 kernel8.img built with pwm_demo as startup program</verify>
  <done>RPi5 build ready for deployment with PWM tracing demo</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>RPi5 kernel with PWM tracing demo. BPF controller varies duty cycle, observer traces each change with nanosecond timestamps via ringbuf.</what-built>
  <how-to-verify>
    1. Deploy: Run `scripts/deploy-rpi5.sh` to flash kernel8.img
    2. Hardware: Connect PWM output to oscilloscope or motor controller (optional — serial output is sufficient to verify)
    3. Boot: Insert SD card, power on RPi5
    4. Observe serial console:
       - pwm_demo starts, creates maps, loads BPF programs
       - Controller program varies PWM duty cycle over time
       - Observer traces each PWM change: "PWM [ch] duty=[X]% at t=[ns]"
       - Timestamps show nanosecond precision
    5. Confirm: Events stream continuously, timestamps increase monotonically, duty values match controller pattern
  </how-to-verify>
  <resume-signal>Type "approved" if PWM tracing with timestamps works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pwm_demo enhanced with ringbuf event tracing
- [ ] RPi5 build succeeds
- [ ] PWM duty cycle changes traced with nanosecond timestamps
- [ ] Events stream to userspace via ringbuf
- [ ] No deadlocks or panics
</verification>

<success_criteria>

- PWM tracing demo runs on real RPi5
- Each duty cycle change produces a timestamped event
- Events visible on serial console via ringbuf polling
- Proves: "motor commands traced with nanosecond precision via BPF"
</success_criteria>

<output>
After completion, create `.planning/phases/02-rpi5-hardware-demos/02-02-SUMMARY.md`
</output>
